name: Deploy to Staging

on:
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Staging environment'
        required: true
        default: 'staging'
        type: string

env:
  FTP_SERVER: s2.open.by
  FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
  FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
  FTP_PATH: /staging
  DOTNET_VERSION: '8.0.x'

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore
      
    - name: ğŸ—ï¸ Build application
      run: dotnet build --no-restore --configuration Debug
      
    - name: ğŸ“¤ Publish application
      run: dotnet publish --no-build --configuration Debug --output ./staging
      
    - name: ğŸ“ Create .htaccess for staging
      run: |
        cat > ./staging/.htaccess << 'EOF'
        RewriteEngine On
        
        # Staging environment - no caching
        <IfModule mod_expires.c>
            ExpiresActive Off
        </IfModule>
        
        # SPA routing
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.html [L]
        EOF
        
    - name: ğŸš€ Deploy to staging
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ env.FTP_SERVER }}
        username: ${{ env.FTP_USERNAME }}
        password: ${{ env.FTP_PASSWORD }}
        local-dir: ./staging/
        server-dir: ${{ env.FTP_PATH }}/
        
    - name: âœ… Staging deploy completed
      run: |
        echo "ğŸ‰ SmartCodeLab Ñ€Ğ°Ğ·Ğ²ĞµÑ€Ğ½ÑƒÑ‚ Ğ² staging Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğ¸!"
        echo "ğŸ”— Staging URL: https://s2.open.by/staging"
        echo "ğŸ“… Ğ’Ñ€ĞµĞ¼Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ: $(date)"
        echo "ğŸ”— PR: ${{ github.event.pull_request.html_url }}"
